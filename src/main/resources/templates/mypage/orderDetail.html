<html xmlns:th="http://www.thymeleaf.org">
<!-- header replace -->
<div th:replace="~{ /fragments/header.html :: header }"></div>
<div th:replace="~{ /fragments/subMenu.html :: subMenu }"></div>
<head>
	<title>All it - I have a All it</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>

<body th:align="center">
<h1>주문 상세</h1>
<div style="display: flex;">
<article>
	<form name="formm" method="post">
	<table id="orderList" class="table">
		<tr>
			<th width="450">상품명</th>
			<th width="80">수 량</th>
			<th width="100">가 격</th> 
			<th width="150">주문일</th> 
			<th width="100">진행 상태</th>
			<th width="150"></th>    
		</tr>
		<!-- <tr th:text="${#dates.format(orderDetailList.orders.regDate, 'yyyy-MM-dd')} +' 주문'" /> -->
		<tr th:each="detail : ${orderDetailList}">
			<td><a th:href="@{ |/product/${ detail.product.pno }| }">
				<img class="img-fluid" th:src="@{ /images/product/ } + ${ detail.product.imageName }" width="100">
					<b class="text-info" th:text="${ detail.product.name }"></b>
				</a> 
				<span th:text="${#numbers.formatInteger(detail.product.price, 1, 'COMMA')}+'원'"></span>
				<input type="button" class="btn btn-outline-secondary" id="inCart" value="장바구니 담기">
			</td>
			<td th:text="${detail.quantity}+'개'"></td>
			<td th:text="${#numbers.formatInteger(detail.product.price*detail.quantity, 1, 'COMMA')}+'원'" />
			<td th:text="${#dates.format(detail.orders.regDate, 'yyyy-MM-dd')}" /></td>
			<th:block th:switch="${detail.status}">
				<td th:case="1">주문완료</td>
				<td th:case="2">배송중</td>
				<td th:case="3">배송완료</td>
				<td th:case="4">구매확정</td>
				<td th:case="5">주문취소</td>
				<td th:case="6">교환신청</td>
				<td th:case="7">반품신청</td>
			</th:block>
			<td>
				<input type="button" th:if="${detail.status == 1}" id="cancelOrder" value="주문취소" class="btn btn-light"> 
				<input type="button" th:if="${detail.status == 2}" id="delivery" value="배송조회" class="btn btn-light"> 
				<input type="button" th:if="${detail.status == 3}" id="buyComplete" value="구매확정" class="btn btn-light"> 
				<input type="button" th:if="${detail.status == 3}" id="refund" value="교환/반품 신청" class="btn btn-light"> 
				<input type="button" class="btn btn-light" id="productQna" value="상품문의"> 
				<input type="button" th:if="${detail.status == 3}" id="writeReview" value="리뷰작성" class="btn btn-light">
				
				<input type="hidden" th:value="${ detail.orders.ono }" id="ono" name="ono">
	 			<input type="hidden" th:value="${ session['user']?.id }" id="mid" name="mid">
	 			<input type="hidden" th:value="${ detail.product.pno }" id="pno" name="pno">
	 			<input type="hidden" th:value="${ detail.odno }" id="odno" name="odno">
	 			<input type="hidden" th:value="${ detail.orders.finalPrice }" id="finalPrice" name="finalPrice">
			</td>
		</tr>
	</table>
<hr><br>
	<h3>받는 사람 정보</h3>
	<table id="receiverInfo" th:each="detail, st : ${orderDetailList}" class="table">
		<tr>
			<th th:if="${st.first == true}">이름</td>
			<td th:if="${st.first == true}" th:text="${detail.receiverName}" />
		</tr>
		<tr>
			<th th:if="${st.first == true}">연락처</th>
			<td th:if="${st.first == true}" th:text="${detail.receiverPhone}" />
		</tr>
		<tr>
			<th th:if="${st.first == true}">배송 주소</th>
			<td th:if="${st.first == true}" th:text="'(' + ${detail.receiverZipcode} + ') ' + ${detail.receiverAddr}" />
		</tr>
	<!--<tr>
			<th>배송 요청사항</th>
			<td>
				<input type="text" id="" name="" required="required" placeholder="배송 요청사항"/>	
			</td>
		</tr>  -->
	</table>
<hr><br>
	<h3>결제 정보</h3>
	<table id="receiverInfo" class="table">
		<tr>
			<th width="250">결제수단</th>
			<td>올잇머니</td>
		</tr>
		<tr>
			<th>총 상품가격</th>
			<td th:text="${ #numbers.formatInteger(totalPrice, 1, 'COMMA') }+'원'" />
		</tr>
		<tr>
			<th>쿠폰 적용</th>
			<td th:text="${ #numbers.formatInteger(coupon, 1, 'COMMA') }+'원'" style="color: red;"/>
		</tr>
		<tr>
			<th>총 결제금액</th>
			<td th:text="${ #numbers.formatInteger(totalPrice - coupon, 1, 'COMMA') }+'원'" style="font-weight: bold;"/>
		</tr>
	</table>
<hr><br>
	<div id="buttons" style="float: right">
		<input type="button" value="≪ 주문목록 돌아가기" class="btn btn-outline-warning" onclick="location.href='/order/orderList'">
		<!-- <input type="button" value="주문내역 삭제" class="btn btn-light" onclick=""> -->     
	</div>
	</form>  
</article>
</div>

<!-- 자바스트립트 섹션 시작 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script type="text/javascript">
let index = {
	init:function() {
		
		$("#inCart").on("click", ()=>{ 
			this.insertCart();
		});
		
		$("#refund").on("click", ()=>{ 
			this.refund();
		});
		
	},

	// 장바구니 담기
	insertCart:function() {
		let user_id = $("#mid").val();
		
		if(user_id == "" || user_id == "undefined") {
			alert('로그인이 필요한 서비스입니다.');
			window.location.href="/member-login";
			return false;
		} else {
			// ajax는 기본이 비동기 호출이기 때문에 만약 뒤에 다른 요청이 있으면 그것도 같이 수행
			// ajax가 통신을 성공하고 서버가 json을 리턴하면 자동으로 자바오브젝트로 변환해줌
			$.ajax({
				url: "/cart/insert",
				type: "post",
				data: JSON.stringify({
					mid: $("#mid").val(),
					pno: $("#pno").val(),
					quantity : 1
				}),
				dataType: "text",
				contentType: "application/json; charset=utf-8", // body 데이터의 타입을 표시
				success: function(data){ // 처리 성공 시
					//alert("[처리결과]"+data);
					if(data == 'inCart') {
						alert('상품이 장바구니에 담겼습니다.');
						//self.history.go(-1);
					} else if(data == 'exist') {
						var chk = confirm('장바구니에 같은 상품이 있습니다. \n그래도 담으시겠습니까?');
						if(chk) {
							//location.replace("/cart/modCart");
							$.ajax({
								url: "/cart/modCart",
								type: "post",
								data: JSON.stringify({
									mid: $("#mid").val(),
									pno: $("#pno").val(),
									quantity : $("#quantity").val(),
									type: "add"
								}),
								dataType: "text",
								contentType: "application/json; charset=utf-8",
								success: function(data){
									if(data == 'modCart') {
										alert('상품이 장바구니에 담겼습니다.');
									} else if(data == 'null') {
										alert('장바구니 조회 중 일시적인 오류입니다.');
									} else {
										alert('로그인이 필요한 서비스입니다.');
									}
								}, error: function(err){
									alert("다시 시도해주세요.");				
									console.log('[modCart() ajax error] '+err);
								}	
							});
						}
					} else {
						alert('로그인이 필요한 서비스입니다.');
					}
				}
			}).fail(function(error){ // 처리 실패 시
				alert("다시 시도해주세요.");
				console.log("[insertCart() ajax error] "+JSON.stringify(error));
			});
		}
	},
	
	// 주문 취소
	cancelOrder:function(ono, odno) {
		let user_id = $("#mid").val();
		
		if(user_id == "" || user_id == "undefined") {
			alert('로그인이 필요한 서비스입니다.');
			window.location.href="/member-login";
			return false;
		} else {
			$.ajax({
				url: "/order/orderCancel",
				type: "post",
				data: JSON.stringify({
					mid: $("#mid").val(),
					ono: ono,
					odno : odno
				}),
				dataType: "text",
				contentType: "application/json; charset=utf-8", // body 데이터의 타입을 표시
				success: function(data){ // 처리 성공 시
					console.log(data);
					alert("선택하신 상품이 주문취소 처리 되었습니다.");
					location.replace("/order/orderList");
				}, error: function(xhr,status,err){
					alert("다시 시도해주세요.");				
					console.log('[cancelOrder() ajax error] '+JSON.stringify(err));
				}
			}).fail(function(error){ // 처리 실패 시
				alert("다시 시도해주세요.");
				console.log("[cancelOrder() ajax error] "+JSON.stringify(error));
			}); 
		}
	},
	
	// 구매 확정
	buyComplete:function(odno) {
		//alert("odno : "+odno);
		let user_id = $("#mid").val();
		
		if(user_id == "" || user_id == "undefined") {
			alert('로그인이 필요한 서비스입니다.');
			window.location.href="/member-login";
			return false;
		} else {
			$.ajax({
				url: "/order/orderComplete",
				type: "post",
				data: JSON.stringify({
					mid: $("#mid").val(),
					//pno: $("#pno").val(),
					//ono: $("#ono").val(),
					odno: odno,
					finalPrice: $("#finalPrice").val() 
				}),
				dataType: "text",
				contentType: "application/json; charset=utf-8", // body 데이터의 타입을 표시
				success: function(data){ // 처리 성공 시
					console.log(data);
					alert("선택하신 상품이 구매확정 처리 되었습니다.");
					location.replace("/order/orderList");
				}, error: function(xhr,status,err){
					alert("다시 시도해주세요.");				
					console.log('[orderComplete() ajax error] '+err);
				}
			}).fail(function(error){ // 처리 실패 시
				alert("다시 시도해주세요.");
				console.log("[orderComplete() ajax error] "+JSON.stringify(error));
			});
		}
	}

}
index.init();
</script>
<!-- 자바스트립트 섹션 끝 -->

</body>

<!-- footer replace -->
<div th:replace="~{ /fragments/footer.html :: footer }"></div>
